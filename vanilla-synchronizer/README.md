> [!WARNING]
> This is a personal project of mine so expect bugs and other issues until this codebase is ironed out. If interested in this codebase's future or want to contribute look down at [Future Plans](#future-plans)

# Vanilla Synchronizer

A tool for Crusader Kings III modders to easily synchronize and update modded files with the latest vanilla game (script) files, while preserving changes to top-level entities and their comments.

## What Does It Do?

- **Synchronizes** your modded files with the latest vanilla files from the game.
- **Preserves** your custom events (by key) and custom comments (using a configurable prefix).
- **Automatically merges** new vanilla content, so you can painlessly update your mod after a Paradox patch.
- **Uses a robust parser** (ANTLR-based) to accurately identify and swap event blocks, not just lines.

## How It Works

1. **Reads your configuration** from `sync-config.yaml` (or whatever you call it, look at `sync-config.example.yaml` for example options).
2. **Parses** both the vanilla and modded files using a custom Go parser generated from the Paradox Script grammar.
3. **For each file** listed in the config:
    - Copies all vanilla content.
    - Replaces any event blocks (e.g. `birth.1001 = { ... }`) with your modded version if you have one.
    - Maintains your custom comments (with your chosen prefix) above the relevant modded events.
    - Writes the merged result to a new file in `sync-output/`.

## Quick Start

### 1. Clone the Repository

```sh
git clone https://github.com/YOURUSERNAME/ck3-quieter-events.git
cd ck3-quieter-events/paradox-file-utils/vanilla-synchronizer
```

### 2. Prepare Your Config

Rename the example config and edit it for your setup:

e.g.
```sh
cp sync-config.example.yaml sync-config.yaml
```

- Edit `sync-config.yaml` and set:
    - `game_root`: Path to your CK3 game directory
    - `mod_root`: Path to the repo root/wherever your modded files are
    - `custom_comment_prefix`: Prefix for your custom comments inside the files you wish to keep (Only works for standalone line comments above top-level entity blocks (events/histories/etc.)
    - `files`: List of files and the keys of your modded entities you want to preserve

### 3. Run the Synchronizer

Either option will write your synced version files to the `sync-output/` directory

#### Option A: Using ***Make*** (Linux/macOS/WSL)

  ```sh
  make build
  ```

#### Option B: Using ***Go***

  ```sh
  ./vanilla-synchronizer sync-config.yaml
  ```

### 4. (Optional) Building the Synchronizer

In case you want to make changes to the synchronizer code and need to rebuild it yourself.
Both options will generate executable binary named `vanilla_synchronizer`

#### Option A: Using ***Make*** (Linux/macOS/WSL)

```sh
make build
```

#### Option B: Using ***Go*** Directly

```sh
go build -o vanilla-synchronizer vanilla_synchronizer.go
```

## Troubleshooting

- **Config not working?**:
  - Make sure you renamed and edited `sync-config.example.yaml`.
  - Also ensure that the config yaml is saved as `UTF-8` Encoding **NOT** `UTF-8 With BOM` like game files (such as localizations).
- **Can't seem to find your files?**:
  - Ensure that both the game root path and mod paths are absolute or Go will likely fail to find them. 
  - Also make sure that the `relative_path` in the config is based on the files path in the game root dir, your modded versions should mirror that structure.
- **Comments From Mod files Not Preserved?**: 
  - Ensure your `custom_comment_prefix` matches exactly (including spaces and `#`) what you use in your mod files. Note that only comments just above modded entities will be preserved, multiling comments are supported though as long as prefix is on all lines.
- **Parser errors?**:
  - Make sure your files are valid Paradox script and encoded as UTF-8 with BOM. If they are and you still have errors message me or open an issue.

## Parser Information

- The synchronizer uses a **Go parser generated by ANTLR** for Paradox Script Language located in [`../parser/`](../parser/).
- This parser pretty accurately understands Paradox event syntax, including nested blocks, assignments, and comments.
- Currently It's based only on grammar need to work with event files, it should work with most other game files but **I have not tested any non-event files** to know for sure. This is definitely something that can be extended so please feel free to PR or message me with requests.
- If you want to see another example of something using this parser look at [`../examples/getting-events.go`](../examples/getting-events.go) where I wrote a smaller script that travers a given event file and outputs all the event blocks and the total number of events in the file. There's so much more you can do though.

## Future Plans

1. I currently plan on improving the synchronizer to also provide a diff either via commandline or through some kind of output diff file. Best case would be GUI but I have no experiance in that realm so unless I find someone who knows how that's currently a pipe dream.
2. I also do plan on extending parser support at some point in the future to handle files beyond events although I believe a good deal of files in the game scripts will likely be parsed pretty accurately.
3. If this gets any kind of traction I'll likely move this to it's own repo but we'll see...

## Contributing

Pull requests and issues are welcome! Feel free to hit my up on github or open an issue and I'll try to respond as soon as I have time.

If you want to extend the parser or add new features, see the [Parser Information](#parser-information).


## License

MIT
